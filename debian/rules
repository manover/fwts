#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all

include /usr/share/dpkg/architecture.mk

VERSION := $(shell dpkg-parsechangelog -SVersion | cut -d':' -f2 | cut -d- -f1)
DKMS_SRC_DIR := $(CURDIR)/debian/fwts-efi-runtime-dkms/usr/src/fwts-efi-runtime-dkms-$(VERSION)

export DEB_LDFLAGS_MAINT_APPEND += -Wl,--as-needed

%:
ifeq ($(DEB_HOST_ARCH),amd64)
	dh $@ --with autoreconf,dkms
else
	dh $@ --with autoreconf
endif

override_dh_autoreconf:
	dh_autoreconf --as-needed

override_dh_clean:
	dh_clean \
		results.log config.log \
		src/acpica/source/compiler/aslcompiler.y

override_dh_auto_install:
	install -d $(DKMS_SRC_DIR)
	cp -a efi_runtime/* $(DKMS_SRC_DIR)
	dh_auto_install

override_dh_dkms:
	dh_dkms -V $(VERSION)

override_dh_auto_test:
ifneq ($(DEB_BUILD_ARCH),arm64)
	dh_auto_test $@
endif
